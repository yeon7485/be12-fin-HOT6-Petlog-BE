pipeline {
    agent any

    environment {
        IMAGE_NAME = 'petlog/backend'
        IMAGE_TAG = "${BUILD_NUMBER}"
        TAG = "0.1.${BUILD_NUMBER}"
        
        // ğŸ”§ ì¶”ê°€ í™˜ê²½ ë³€ìˆ˜ë“¤
    DEPLOY_TARGET = 'test@192.0.60.11'
    SERVICE_NAME = 'backend-service'
    LOCAL_K8S_PATH = 'backend/k8s'
    K8S_PATH = '/home/test/k8s/backend'
    }

    stages {
        stage('Git Clone') {
            steps {
                echo "âœ… Cloning Backend Repository"
                git branch: 'main', url: 'https://github.com/beyond-sw-camp/be12-fin-HOT6-Petlog-BE'
            }
        }

        stage('Build JAR') {
    steps {
        dir('backend') {
            echo "ğŸ”§ Giving gradlew permission"
            sh 'chmod +x gradlew'

            echo "ğŸ”§ Building Spring Boot Application"
            sh './gradlew clean build -x test'
        }
    }
}

        stage('Docker Build & Push') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'DOCKER_USER', usernameVariable: 'DOCKER_ID', passwordVariable: 'DOCKER_PW')
                ]) {
                    script {
                        echo "ğŸ³ Docker Build"
                        sh "docker build -t ${IMAGE_NAME}:${TAG} ./backend"

                        echo "ğŸ” Docker Login"
                        sh "echo $DOCKER_PW | docker login -u $DOCKER_ID --password-stdin"

                        echo "ğŸ“¦ Docker Push"
                        sh "docker push ${IMAGE_NAME}:${TAG}"
                    }
                }
            }
        }
        
        stage('Blue/Green Backend Deploy') {
      steps {
        script {
          def tag = "0.1.${BUILD_ID}"
          def isGreen = (BUILD_ID.toInteger() % 2 == 0)
          def deployColor = isGreen ? "green" : "blue"
          def oldColor = isGreen ? "blue" : "green"

          echo "ğŸš€ BUILD_ID: ${BUILD_ID} â†’ Deploying: ${deployColor.toUpperCase()}"

          // 1. YAML íŒŒì¼ ë³µì‚¬ ë° íƒœê·¸ ì¹˜í™˜
          sh """
            ssh -o StrictHostKeyChecking=no ${DEPLOY_TARGET} "mkdir -p ${K8S_PATH}"

            scp -o StrictHostKeyChecking=no ${LOCAL_K8S_PATH}/backend-deployment-${deployColor}.yml ${DEPLOY_TARGET}:${K8S_PATH}/
            scp -o StrictHostKeyChecking=no ${LOCAL_K8S_PATH}/backend-service.yml ${DEPLOY_TARGET}:${K8S_PATH}/

            ssh ${DEPLOY_TARGET} "sed -i 's/latest/${tag}/g' ${K8S_PATH}/backend-deployment-${deployColor}.yml"
          """

          // 2. ì‹ ê·œ ë°°í¬ ë°˜ì˜ ë° ì•ˆì •í™” í™•ì¸
          sh """
            ssh ${DEPLOY_TARGET} kubectl apply -f ${K8S_PATH}/backend-deployment-${deployColor}.yml
            ssh ${DEPLOY_TARGET} kubectl rollout status deployment/backend-${deployColor} -n default
            ssh ${DEPLOY_TARGET} kubectl wait --for=condition=available deployment/backend-${deployColor} --timeout=120s -n default
          """

          // 3. Serviceì˜ selectorë¥¼ ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜
sh """
  echo "ğŸ” Switching service to: ${deployColor}"
  ssh ${env.DEPLOY_TARGET} \\
    "kubectl patch service ${env.SERVICE_NAME} -n default -p '{\\\"spec\\\": {\\\"selector\\\": {\\\"type\\\": \\\"backend-app\\\", \\\"deployment\\\": \\\"${deployColor}\\\"}}}'"
"""
          // 4. ì´ì „ ë²„ì „ replica ìˆ˜ ì¤„ì´ê¸°
          sh """
            echo "ğŸ§¹ Scaling down old deployment: ${oldColor}"
            ssh ${DEPLOY_TARGET} kubectl scale deployment/backend-${oldColor} --replicas=0 -n default || true
          """
        }
      }
    }
    }
}